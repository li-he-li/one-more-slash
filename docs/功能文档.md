# SecondMe 应用 - 功能文档

## 项目概述

本项目是一个基于 Next.js + SecondMe API 的 Web 应用，实现了用户 OAuth2 认证、会话管理和用户信息展示等功能。

**技术栈**: Next.js 15.1.3, React 19, TypeScript, Tailwind CSS, Prisma, SQLite

**官方文档**: https://develop-docs.second.me/zh/docs

---

## 已实现功能

### 1. 用户认证模块 (OAuth2)

#### 功能描述
通过 SecondMe OAuth2 进行用户登录认证，支持完整的授权流程（Authorization Code 流程）。

#### 实现方式
- 前端跳转到 SecondMe 授权页面
- 后端接收授权码并交换 access_token
- 获取并保存用户信息到数据库
- 设置 session cookie

#### 涉及页面
- 首页 (`/`) - 登录页面
- Dashboard (`/dashboard`) - 登录后页面

---

### 2. 会话管理

#### 功能描述
管理用户登录状态，支持登录状态检查和登出。

#### 实现方式
- 使用 HTTP-only cookie 存储 session
- 前端自动检查登录状态
- 未登录用户重定向到首页

#### 涉及页面
- 首页 (`/`) - 自动检查并跳转
- Dashboard (`/dashboard`) - 需要登录才能访问

---

### 3. 用户信息展示

#### 功能描述
在 Dashboard 显示用户的基本信息（姓名、邮箱、头像等）。

#### 实现方式
- 从 session cookie 读取用户信息
- 在 Dashboard 页面展示用户详情

---

## API 路由文档

### 1. OAuth2 授权回调

**路由**: `GET /api/auth/callback/secondme`

**功能**: 处理 SecondMe OAuth2 授权回调，交换 access_token 并保存用户信息

**请求参数** (Query):
| 参数 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `code` | string | 是 | 授权码（从 SecondMe 获取） |
| `error` | string | 否 | 错误信息（授权失败时） |

**流程**:
1. 验证授权码
2. 调用 SecondMe API 交换 access_token
3. 获取用户信息
4. 保存用户信息到数据库（Prisma）
5. 设置 session cookie
6. 重定向到 `/dashboard`

**使用的 SecondMe API**:
- `POST https://app.mindos.com/gate/lab/api/oauth/token/code` - Token 交换
- `GET https://app.mindos.com/gate/lab/api/secondme/user/info` - 获取用户信息

**返回**: 重定向到 `/dashboard` 或首页（带错误参数）

---

### 2. 获取当前用户信息

**路由**: `GET /api/auth/me`

**功能**: 获取当前登录用户的信息

**请求**:
- 无请求参数
- 需要有效的 session cookie

**返回值**:
```typescript
{
  user: {
    userId: string,    // SecondMe 用户 ID
    accessToken: string,
    name: string,
    email: string,
    image: string
  } | null
}
```

**状态码**:
- `200` - 成功返回用户信息
- `401` - 未登录或 session 过期

---

### 3. 用户登出

**路由**: `POST /api/auth/logout`

**功能**: 清除用户 session，实现登出功能

**请求**:
- 无请求参数
- 无需认证（会清除 cookie）

**返回值**:
```typescript
{
  success: true
}
```

---

### 4. NextAuth 配置（备用/未使用）

**路由**: `GET|POST /api/auth/[...nextauth]`

**功能**: NextAuth.js 配置（当前项目中未实际使用，主要使用自定义 OAuth 流程）

**说明**: 此路由存在但未在项目中使用，实际的 OAuth 流程通过 `/api/auth/callback/secondme` 实现。

---

## 数据库模型

### User 表

**模型定义**: `prisma/schema.prisma`

```typescript
model User {
  id            String    @id @default(cuid())
  secondmeId    String    @unique    // SecondMe 用户 ID（唯一标识）
  accessToken   String                 // 访问令牌
  refreshToken  String?                // 刷新令牌（可选）
  expiresAt     DateTime?              // Token 过期时间（可选）
  name          String?                // 用户姓名
  email         String?                // 用户邮箱
  image         String?                // 用户头像 URL
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

**索引**: `secondmeId` 字段唯一索引

---

## 核心工具函数

### `lib/secondme.ts`

提供与 SecondMe API 交互的工具函数：

#### `getAccessToken(code: string, redirectUri?: string)`
交换授权码获取 access_token

#### `getUserInfo(accessToken: string)`
使用 access_token 获取用户信息

#### `refreshAccessToken(refreshToken: string)`
使用 refresh_token 刷新 access_token

#### `buildFormBody(data: Record<string, string>)`
构建 `application/x-www-form-urlencoded` 格式的请求体

---

## 环境变量配置

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `NEXT_PUBLIC_SECONDME_APP_ID` | SecondMe 应用 ID | `cc57d53a-eac5-48ee-a662-64553a12c390` |
| `SECONDME_APP_ID` | 服务端应用 ID | 同上 |
| `SECONDME_APP_SECRET` | 应用密钥 | `your-secret-here` |
| `SECONDME_OAUTH_ENDPOINT` | OAuth 授权端点 | `https://go.second.me/oauth/` |
| `SECONDME_API_ENDPOINT` | API 端点 | `https://app.mindos.com/gate/lab` |
| `NEXTAUTH_URL` | 应用 URL（可选） | `http://localhost:3000` |
| `DATABASE_URL` | 数据库连接字符串 | `file:./dev.db` |

---

## 待开发功能

以下功能已在首页展示，但尚未实际实现：

1. **AI 智能对话** - 使用 SecondMe Chat API
2. **兴趣标签系统** - 使用 `user.info.shades` API
3. **软记忆功能** - 使用 `user.info.softmemory` API

---

## 重要注意事项

### SecondMe API 响应格式

所有 SecondMe API 响应都遵循统一格式：

```json
{
  "code": 0,
  "data": { ... }  // 实际数据在 data 字段内
}
```

前端/后端代码必须正确提取 `data` 字段内的数据。

### Token 字段命名

SecondMe API 返回的 token 相关字段使用 **camelCase**：
- `accessToken` (不是 `access_token`)
- `refreshToken` (不是 `refresh_token`)
- `expiresIn` (不是 `expires_in`)

### 用户 ID 字段

SecondMe 用户信息中的 ID 字段名为 `userId`（不是 `id`）。

### Content-Type 要求

Token 交换 API 要求请求头使用 `application/x-www-form-urlencoded` 格式。

### Session Cookie 配置

Session cookie 配置：
- `httpOnly: true` - 防止 XSS 攻击
- `secure: true` (生产环境) - 仅 HTTPS
- `sameSite: "lax"` - CSRF 保护

---

## 相关资源

- [SecondMe 快速入门](https://develop-docs.second.me/zh/docs)
- [OAuth2 指南](https://develop-docs.second.me/zh/docs/authentication/oauth2)
- [SecondMe API 参考](https://develop-docs.second.me/zh/docs/api-reference/secondme)
- [Next.js 文档](https://nextjs.org/docs)
- [Prisma 文档](https://www.prisma.io/docs)
